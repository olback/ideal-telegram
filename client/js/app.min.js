"use strict";const socket=io.connect(window.location.origin);let online=[],typing=[],selected=null;function toast(msg,time=5e3){const dialog=document.getElementById("toast");dialog.innerHTML=msg,dialog.style.display="block",setTimeout(()=>{dialog.style.display="none"},time)}function modal(t,p){const m=document.getElementById("modal");m.children[0].innerHTML=t,m.children[1].innerHTML=p,m.style.display="block",m.children[2].onclick=(()=>{m.style.display="none"})}function friendsList(username=null){const fl=document.getElementById("friends-list");fl.innerHTML="";let a=JSON.parse(window.localStorage.getItem("friends"));for(let i=0;i<a.length;i++)a[i].username===username?online.indexOf(a[i].username)>=0?fl.innerHTML+=`<div class="friend active online">${escapeHtml(a[i].username)}</div>`:fl.innerHTML+=`<div class="friend active">${escapeHtml(a[i].username)}</div>`:online.indexOf(a[i].username)>=0?a[i].unread?fl.innerHTML+=`<div class="friend online unread" onclick="selectFriend('${escapeHtml(a[i].username)}')">${escapeHtml(a[i].username)}</div>`:fl.innerHTML+=`<div class="friend online" onclick="selectFriend('${escapeHtml(a[i].username)}')">${escapeHtml(a[i].username)}</div>`:a[i].unread?fl.innerHTML+=`<div class="friend unread" onclick="selectFriend('${escapeHtml(a[i].username)}')">${escapeHtml(a[i].username)}</div>`:fl.innerHTML+=`<div class="friend" onclick="selectFriend('${escapeHtml(a[i].username)}')">${escapeHtml(a[i].username)}</div>`}function selectFriend(username=null){let a=JSON.parse(window.localStorage.getItem("friends"));const h1=document.getElementById("h1-name");if("string"==typeof username){for(let i=0;i<a.length;i++)if(a[i].username===username){friendsList(a[i].username),h1.innerHTML=escapeHtml(a[i].username),selected=a[i].username;for(let f of a)f.username===username&&(f.unread=!1,localStorage.setItem("friends",JSON.stringify(a)))}}else a.length>0?(friendsList(a[0].username),h1.innerHTML=escapeHtml(a[0].username),selected=a[0].username):(friendsList(),h1.innerHTML="Chat",selected=null);renderChat(username)}function renderChat(username){const co=document.getElementById("chat-output"),cm=JSON.parse(window.sessionStorage.getItem(username));if(co.innerHTML="",username&&null!==cm){for(let i=0;i<cm.length;i++)appendChat(cm[i].from,cm[i].message);co.scrollTo({top:co.scrollHeight,behavior:"smooth"})}else co.innerHTML='<div class="chat-info">No messages</div>'}function appendChat(username,message){const co=document.getElementById("chat-output");1===co.children.length&&"No messages"===co.children[0].innerText&&co.children[0].classList.contains("chat-info")&&(co.innerHTML=""),co.innerHTML+=`<div class="message"><span>${escapeHtml(username)}</span>${escapeHtml(message)}</div>`,co.scrollTo({top:co.scrollHeight+100,behavior:"smooth"})}async function sendMessage(to,message){if(null===to)return toast("No receiver specified");const from=window.localStorage.getItem("username");let m={to:to,from:from,message:null},friend=null,a=JSON.parse(window.localStorage.getItem("friends"));for(let i=0;i<a.length;i++)if(a[i].username===to){friend=a[i];break}const options={data:message,publicKeys:openpgp.key.readArmored(atob(friend.public_key)).keys};openpgp.encrypt(options).then(ciphertext=>{m.message=btoa(ciphertext.data)}).then(()=>{socket.emit("message",m),appendChat(m.from,message)})}function notify(title,body){Notification.requestPermission(result=>{"granted"===result&&(navigator.serviceWorker.ready.then(registration=>{registration.showNotification(title,{body:body,icon:"/img/icon.png",vibrate:[200,100,200],tag:"encm"})}),new Audio("/audio/notif.ogg").play())})}function setDarkTheme(b){if(b){document.documentElement.style.setProperty("--background-color-main","#1f1f1f"),document.documentElement.style.setProperty("--background-color-secondary","#333"),document.documentElement.style.setProperty("--border-color","#222"),document.documentElement.style.setProperty("--text-color-primary","#ddd"),document.documentElement.style.setProperty("--text-color-primary-hover","#fff"),document.documentElement.style.setProperty("--text-color-secondary","#ccc"),document.documentElement.style.setProperty("--text-bcolor-secondary-hover","#111"),document.documentElement.style.setProperty("--dialog-background-color","#111"),document.documentElement.style.setProperty("--input-bcolor","#565656"),document.getElementById("theme-switch").classList.replace("fa-moon","fa-sun");let s=JSON.parse(window.localStorage.getItem("settings"));s.dark=!0,window.localStorage.setItem("settings",JSON.stringify(s))}else{document.documentElement.style.setProperty("--background-color-main","#fff"),document.documentElement.style.setProperty("--background-color-secondary","#f9f9f9"),document.documentElement.style.setProperty("--border-color","#e9e9e9"),document.documentElement.style.setProperty("--text-color-primary","#333"),document.documentElement.style.setProperty("--text-color-primary-hover","#111"),document.documentElement.style.setProperty("--text-color-secondary","#555"),document.documentElement.style.setProperty("--text-bcolor-secondary-hover","#ccc"),document.documentElement.style.setProperty("--dialog-background-color","#555"),document.documentElement.style.setProperty("--input-bcolor","#fff"),document.getElementById("theme-switch").classList.replace("fa-sun","fa-moon");let s=JSON.parse(window.localStorage.getItem("settings"));s.dark=!1,window.localStorage.setItem("settings",JSON.stringify(s))}}function escapeHtml(unsafe){return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}if(document.getElementById("send").onclick=(()=>{const i=document.getElementById("new-message");if(""!==i.value.trim()){if(null===selected)return toast("No receiver specified");sendMessage(selected,i.value),Encm.sessionStoreMessage(selected,window.localStorage.getItem("username"),i.value),i.value=""}else toast("Cannot send empty messages")}),document.getElementById("new-message").onkeypress=(e=>{"Enter"===e.code&&(document.getElementById("send").onclick(),document.getElementById("send").focus())}),document.getElementById("new-message").onfocus=(()=>{if(null!==selected){let m={to:selected,from:window.localStorage.getItem("username"),typing:!0};socket.emit("typing",m)}}),document.getElementById("new-message").onblur=(()=>{if(null!==selected){let m={to:selected,from:window.localStorage.getItem("username"),typing:!1};socket.emit("typing",m)}}),document.getElementById("open-delete").onclick=(()=>{const m=document.getElementById("delete-friend"),i=document.getElementById("delete-input"),b=document.getElementById("delete-button");m.style.display="block",b.onclick=(()=>{if(""!==i.value){const r=Encm.delFriend(i.value);toast(r.msg),i.value===selected&&(selected=null),r.error||(selectFriend(selected),i.value="",b.innerHTML="Close"),m.style.display="none"}else m.style.display="none"}),i.onkeyup=(()=>{""!==i.value?b.innerHTML="Delete":b.innerHTML="Close"})}),document.getElementById("open-export-json").onclick=(()=>{const j={username:window.localStorage.getItem("username"),public_key:btoa(window.localStorage.getItem("pgp.public"))};modal("Export",`<code>${JSON.stringify(j)}</code>`)}),document.getElementById("add-friend").onclick=(()=>{const m=document.getElementById("import"),i=document.getElementById("import-json"),b=document.getElementById("import-json-button");b.onclick=(()=>{if(""!==i.value)try{const j=JSON.parse(i.value);if(Encm.isFriend(j.username))throw m.style.display="none",`${j.username} is already in your friends list.`;Encm.addFriend(j.username,j.public_key),m.style.display="none",toast(`Contact successfully ${j.username} imported.`),i.value="",selectFriend(selected),b.innerHTML="Close"}catch(e){toast(e)}else m.style.display="none"}),i.onkeyup=(()=>{""!==i.value?b.innerHTML="Import":b.innerHTML="Close"}),m.style.display="block"}),document.getElementById("theme-switch").onclick=(e=>{e.target.classList.contains("fa-sun")?setDarkTheme(!1):setDarkTheme(!0)}),selectFriend(),renderChat(selected),socket.on("message",async data=>{const passphrase=window.localStorage.getItem("pgp.passphrase"),privKeyObj=openpgp.key.readArmored(window.localStorage.getItem("pgp.private")).keys[0];await privKeyObj.decrypt(passphrase);const options={message:openpgp.message.readArmored(atob(data.message)),privateKeys:[privKeyObj]};if(openpgp.decrypt(options).then(plaintext=>(data.from===selected&&appendChat(data.from,plaintext.data),Encm.sessionStoreMessage(data.from,data.from,plaintext.data),notify(`New message from ${data.from}`,plaintext.data),plaintext.data)),data.from!==selected){const fl=JSON.parse(localStorage.getItem("friends"));for(let f of fl)f.username===data.from&&(f.unread=!0,localStorage.setItem("friends",JSON.stringify(fl)))}}),socket.on("typing",data=>{const i=document.getElementById("new-message");if(data.typing)typing.push(data.from);else{let index=typing.indexOf(data.from);index>=0&&typing.splice(index,1)}typing.length>0?i.placeholder=`${typing.join(", ")} is typing...`:i.placeholder="Message..."}),socket.on("online",data=>{friendsList(selected),online=data}),socket.on("err",data=>{toast(data.msg)}),"granted"!==Notification.permission&&Notification.requestPermission(p=>{toast("granted"===p?"Notifications enabled":"Notifications disabled")}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js",{scope:"/"}).then(registration=>{console.log("ServiceWorker registration successful with scope: ",registration.scope)},err=>{console.error("ServiceWorker registration failed: ",err)})}),null===window.localStorage.getItem("settings"))window.localStorage.setItem("settings",JSON.stringify({dark:!1}));else{let s;setDarkTheme(JSON.parse(window.localStorage.getItem("settings")).dark)}socket.emit("login",window.localStorage.getItem("username")),setInterval(()=>{socket.emit("login",window.localStorage.getItem("username"))},1e3);